<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ–å­¸è¡¨ç¤ºè½‰æ›å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ SmilesDrawer (ä¿ç•™å‚™ç”¨ï¼Œä½†ä¸»è¦ç¹ªåœ–æ”¹ç”¨ RDKit) -->
    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <!-- å¼•å…¥ RDKit ç”¨æ–¼è¨ˆç®—åˆ†å­æŒ‡ç´‹èˆ‡ç¹ªåœ– -->
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
    <!-- å¼•å…¥ 3Dmol.js ç”¨æ–¼ç¹ªè£½ 3D çµæ§‹ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.4.2/3Dmol-min.js"></script>
    <!-- å¼•å…¥ gif.js ç”¨æ–¼ç”Ÿæˆ GIF å‹•ç•« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
        }
        .step-card {
            transition: all 0.3s ease;
        }
        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .arrow-down {
            display: flex;
            justify-content: center;
            padding: 10px;
            color: #9ca3af;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-5px);}
            60% {transform: translateY(-3px);}
        }
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* åˆ†å­æŒ‡ç´‹ä½å…ƒæ¨£å¼ */
        .bit-box {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 1px;
            border-radius: 1px;
        }
        .bit-1 { background-color: #f97316; } /* Orange for active */
        .bit-0 { background-color: #e5e7eb; } /* Gray for inactive */
        
        /* 3D Viewer Container */
        #container-3d {
            width: 100%;
            height: 400px;
            position: relative;
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        /* SVG å®¹å™¨æ¨£å¼ä¿®æ­£ */
        #structure-container svg {
            width: 100%;
            height: 100%;
            max-height: 100%;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto space-y-4">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 tracking-tight">ğŸ§ª åŒ–å­¸è¡¨ç¤ºè½‰æ›å·¥å…·</h1>
            <p class="text-gray-600 mt-2">å…­éšæ®µå·¥å…·ï¼šç¿»è­¯ â” åŒ–å­¸å¼ â” SMILES â” æŒ‡ç´‹ â” 3D â” é€†åˆæˆåˆ†æ</p>
        </div>

        <!-- Step 1: ç¿»è­¯ -->
        <div class="step-card bg-white rounded-xl shadow-md overflow-hidden border-l-8 border-purple-500">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="bg-purple-100 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">1</span>
                        ä¸­è‹±ç¿»è­¯
                    </h2>
                    <span class="text-xs font-semibold text-purple-600 bg-purple-50 px-2 py-1 rounded">Wikipedia API</span>
                </div>
                
                <div class="flex gap-2">
                    <input type="text" id="input-trans" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"
                        placeholder="è¼¸å…¥ä¸­æ–‡ä¿—å (å¦‚: é˜¿æ–¯åŒ¹éˆ)">
                    <button onclick="doTranslate()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition flex items-center gap-2">
                        <span>ç¿»è­¯</span>
                        <div id="loader-trans" class="spinner hidden"></div>
                    </button>
                </div>
                
                <!-- çµæœé¡¯ç¤º -->
                <div id="result-trans" class="hidden mt-4 p-3 bg-purple-50 rounded-lg border border-purple-100 text-purple-900 flex justify-between items-center">
                    <div>
                        <span class="text-xs text-purple-500 uppercase font-bold">English Name</span>
                        <div id="out-trans-text" class="font-bold text-lg"></div>
                    </div>
                    <span class="text-xs text-gray-400">å·²è‡ªå‹•å¡«å…¥ä¸‹ä¸€æ­¥ â¬‡</span>
                </div>
                <div id="error-trans" class="hidden mt-2 text-red-500 text-sm"></div>
            </div>
        </div>

        <!-- Arrow -->
        <div class="arrow-down">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
        </div>

        <!-- Step 2: åŒ–å­¸å¼ -->
        <div class="step-card bg-white rounded-xl shadow-md overflow-hidden border-l-8 border-blue-500">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">2</span>
                        æŸ¥è©¢åŒ–å­¸å¼
                    </h2>
                    <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded">PubChem Data</span>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="input-formula" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="è¼¸å…¥è‹±æ–‡åç¨± (å¦‚: Aspirin)">
                    <button onclick="doGetFormula()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition flex items-center gap-2">
                        <span>æŸ¥è©¢</span>
                        <div id="loader-formula" class="spinner hidden"></div>
                    </button>
                </div>

                <!-- çµæœé¡¯ç¤º -->
                <div id="result-formula" class="hidden mt-4 bg-blue-50 rounded-lg border border-blue-100 overflow-hidden">
                    <div class="p-3 border-b border-blue-100 flex justify-between items-center">
                        <div>
                            <span class="text-xs text-blue-500 uppercase font-bold">Molecular Formula</span>
                            <div id="out-formula-text" class="font-mono font-bold text-xl text-blue-900"></div>
                        </div>
                        <div class="text-right">
                             <span class="text-xs text-blue-400">CID</span>
                             <div id="out-cid-text" class="text-sm font-mono text-blue-700"></div>
                        </div>
                    </div>
                    <div class="p-3 bg-white">
                        <span class="text-xs text-gray-400 uppercase font-bold">IUPAC Name</span>
                        <div id="out-iupac-text" class="text-sm text-gray-600 italic"></div>
                    </div>
                </div>
                 <div id="error-formula" class="hidden mt-2 text-red-500 text-sm"></div>
            </div>
        </div>

        <!-- Arrow -->
        <div class="arrow-down">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
        </div>

        <!-- Step 3: SMILES & çµæ§‹ -->
        <div class="step-card bg-white rounded-xl shadow-md overflow-hidden border-l-8 border-green-500">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">3</span>
                        SMILES èˆ‡ 2D çµæ§‹
                    </h2>
                    <span class="text-xs font-semibold text-green-600 bg-green-50 px-2 py-1 rounded">RDKit Engine</span>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="input-smiles" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                        placeholder="è¼¸å…¥åç¨±æˆ–åŒ–å­¸å¼">
                    <button onclick="doGetSmiles()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition flex items-center gap-2">
                        <span>è½‰æ›</span>
                        <div id="loader-smiles" class="spinner hidden"></div>
                    </button>
                </div>

                <!-- çµæœé¡¯ç¤º -->
                <div id="result-smiles" class="hidden mt-6">
                    
                    <div class="mb-2">
                        <span class="text-xs text-gray-500 font-bold uppercase">Canonical SMILES</span>
                        <div class="flex mt-1">
                            <code id="out-smiles-code" class="flex-1 bg-gray-800 text-green-400 p-3 rounded-l-lg font-mono text-sm break-all"></code>
                            <button onclick="copySmiles()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-4 rounded-r-lg transition" title="è¤‡è£½ SMILES">ğŸ“‹</button>
                        </div>
                    </div>

                    <!-- é€™è£¡æ”¹ç”¨ DIV ä¾†æ”¾ SVGï¼Œè€Œä¸æ˜¯ Canvas -->
                    <div class="mt-4 border border-gray-200 rounded-lg p-2 bg-white flex justify-center items-center shadow-inner relative" style="height: 350px;">
                         <div id="structure-container" class="w-full h-full flex justify-center items-center"></div>
                         
                         <!-- ä¸‹è¼‰æŒ‰éˆ• -->
                         <button onclick="downloadStructureImage()" class="absolute bottom-2 right-2 bg-white/90 hover:bg-white border border-gray-200 shadow-sm px-3 py-1.5 rounded-lg text-gray-500 hover:text-green-600 transition flex items-center gap-1 text-xs font-bold ring-1 ring-gray-100" title="ä¸‹è¼‰ PNG åœ–ç‰‡">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            ä¸‹è¼‰ç™½åº•åœ–ç‰‡
                         </button>
                    </div>
                </div>
                <div id="error-smiles" class="hidden mt-2 text-red-500 text-sm"></div>
            </div>
        </div>

        <!-- Arrow -->
        <div class="arrow-down">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
        </div>

        <!-- Step 4: åˆ†å­æŒ‡ç´‹ -->
        <div class="step-card bg-white rounded-xl shadow-md overflow-hidden border-l-8 border-orange-500">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">4</span>
                        åˆ†å­æŒ‡ç´‹ (ECFP4)
                    </h2>
                    <span class="text-xs font-semibold text-orange-600 bg-orange-50 px-2 py-1 rounded">RDKit Engine</span>
                </div>
                
                <div id="rdkit-loading" class="text-sm text-orange-500 mb-2 italic flex items-center gap-2">
                    <div class="spinner border-orange-200 border-t-orange-500 w-4 h-4"></div>
                    RDKit å¼•æ“åˆå§‹åŒ–ä¸­...
                </div>

                <div class="flex gap-2">
                    <input type="text" id="input-fingerprint" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                        placeholder="ç­‰å¾… SMILES è¼¸å…¥..." readonly>
                    <button id="btn-fingerprint" onclick="doGetFingerprint()" disabled class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-medium transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>ç”ŸæˆæŒ‡ç´‹</span>
                    </button>
                </div>

                <!-- çµæœé¡¯ç¤º -->
                <div id="result-fingerprint" class="hidden mt-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-500 font-bold uppercase">Fingerprint Visualisation (2048 bits)</span>
                        <div class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full font-bold">
                            Active Bits: <span id="active-bits-count">0</span>
                        </div>
                    </div>
                    
                    <div id="fingerprint-matrix" class="p-2 bg-white border border-gray-200 rounded-lg leading-none overflow-y-auto max-h-48 shadow-inner"></div>
                </div>
                <div id="error-fingerprint" class="hidden mt-2 text-red-500 text-sm"></div>
            </div>
        </div>

        <!-- Arrow -->
        <div class="arrow-down">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
        </div>

        <!-- Step 5: 3D çµæ§‹ -->
        <div class="step-card bg-white rounded-xl shadow-md overflow-hidden border-l-8 border-teal-500">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="bg-teal-100 text-teal-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">5</span>
                        3D ç«‹é«”çµæ§‹
                    </h2>
                    <span class="text-xs font-semibold text-teal-600 bg-teal-50 px-2 py-1 rounded">3Dmol.js</span>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="input-3d" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                        placeholder="ç­‰å¾… CID..." readonly>
                    <button onclick="doGet3D()" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg font-medium transition flex items-center gap-2">
                        <span>ç”Ÿæˆæ¨¡å‹</span>
                        <div id="loader-3d" class="spinner hidden"></div>
                    </button>
                </div>

                <!-- 3D æª¢è¦–å™¨ -->
                <div id="result-3d" class="hidden mt-6">
                    <div class="border border-gray-200 rounded-lg p-2 bg-gray-50 shadow-inner relative">
                         <div id="container-3d" class="relative"></div>
                         
                         <!-- ä¸‹è¼‰æŒ‰éˆ•å€ -->
                         <div class="absolute bottom-4 right-4 flex gap-2 z-10">
                            <!-- ä¸‹è¼‰ PNG -->
                             <button onclick="download3DImage()" class="bg-white/90 hover:bg-white border border-gray-200 shadow-sm px-3 py-1.5 rounded-lg text-gray-500 hover:text-teal-600 transition flex items-center gap-1 text-xs font-bold ring-1 ring-gray-100" title="ä¸‹è¼‰ PNG åœ–ç‰‡">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                PNG
                             </button>
                             
                             <!-- ä¸‹è¼‰ GIF -->
                             <button id="btn-gif" onclick="download3DGIF()" class="bg-white/90 hover:bg-white border border-gray-200 shadow-sm px-3 py-1.5 rounded-lg text-gray-500 hover:text-teal-600 transition flex items-center gap-1 text-xs font-bold ring-1 ring-gray-100" title="ä¸‹è¼‰æ—‹è½‰ GIF å‹•ç•«">
                                <span id="gif-text" class="flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                    GIF å‹•ç•«
                                </span>
                                <div id="loader-gif" class="hidden w-3 h-3 border-2 border-teal-500 border-t-transparent rounded-full animate-spin"></div>
                             </button>
                         </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 italic text-center">* ä½¿ç”¨æ»‘é¼ å·¦éµæ—‹è½‰ï¼Œå³éµç§»å‹•ï¼Œæ»¾è¼ªç¸®æ”¾</p>
                </div>
                <div id="error-3d" class="hidden mt-2 text-red-500 text-sm"></div>
            </div>
        </div>

        <!-- Arrow -->
        <div class="arrow-down">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
        </div>

        <!-- Step 6: é€†åˆæˆåˆ†æ (æ–°å¢) -->
        <div class="step-card bg-white rounded-xl shadow-md overflow-hidden border-l-8 border-rose-500">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span class="bg-rose-100 text-rose-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">6</span>
                        é€†åˆæˆè·¯å¾‘åˆ†æ (Retrosynthesis)
                    </h2>
                    <span class="text-xs font-semibold text-rose-600 bg-rose-50 px-2 py-1 rounded">Educational Logic</span>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="input-retro" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 outline-none"
                        placeholder="ç­‰å¾… SMILES è¼¸å…¥..." readonly>
                    <button onclick="doRetrosynthesis()" class="bg-rose-600 hover:bg-rose-700 text-white px-6 py-2 rounded-lg font-medium transition flex items-center gap-2">
                        <span>é–‹å§‹åˆ†æ</span>
                        <div id="loader-retro" class="spinner hidden"></div>
                    </button>
                </div>

                <!-- é€†åˆæˆçµæœ -->
                <div id="result-retro" class="hidden mt-6">
                    <div id="retro-content" class="space-y-6">
                        <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </div>
                </div>
                <div id="error-retro" class="hidden mt-2 text-red-500 text-sm"></div>
            </div>
        </div>
        
        <div class="text-center text-gray-400 text-xs py-4">
            <p>Data provided by PubChem, Wikipedia & RDKit</p>
            <p class="mt-1 font-medium text-gray-500">made by wangyinan</p>
        </div>

    </div>

    <!-- åœ–ç‰‡ç‡ˆç®± (Modal) -->
    <div id="image-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity" onclick="closeModal()">
        <div class="relative max-w-4xl max-h-[90vh] w-full flex items-center justify-center">
            <!-- åœ–ç‰‡å®¹å™¨ -->
            <div class="bg-white p-2 rounded-xl shadow-2xl relative" onclick="event.stopPropagation()">
                <img id="modal-image" src="" alt="Structure Zoom" class="max-w-full max-h-[80vh] object-contain rounded-lg">
                <!-- è¼‰å…¥ä¸­å‹•ç•« -->
                <div id="modal-loader" class="absolute inset-0 flex items-center justify-center bg-white/50 rounded-lg hidden">
                    <div class="spinner border-gray-300 border-t-rose-500 w-10 h-10"></div>
                </div>
            </div>
            
            <!-- é—œé–‰æŒ‰éˆ• -->
            <button class="absolute -top-12 right-0 bg-white/10 hover:bg-white/30 text-white rounded-full p-2 transition focus:outline-none" onclick="closeModal()">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let currentCID = null;
        let RDKitModule = null;
        let viewer3D = null; // 3Dmol viewer å¯¦ä¾‹

        // === é€†åˆæˆè³‡æ–™åº« (Educational Library) ===
        const MOLECULE_LIBRARY = {
            "CC(=O)Oc1ccccc1C(=O)O": {
                name: "é˜¿æ–¯åŒ¹éˆ (Aspirin)",
                description: "éé¡å›ºé†‡æ¶ˆç‚è—¥ï¼Œç¶“å…¸çš„é…¯åŒ–åæ‡‰ç”¢ç‰©ã€‚",
                steps: [{
                    type: "åˆ‡æ–· (Disconnection)",
                    target: "é…¯éµ (Ester Linkage)",
                    explanation: "åˆ‡æ–·é…šé…¯éµï¼Œé€™æ˜¯æœ€å®¹æ˜“å½¢æˆçš„éµçµã€‚",
                    reagents: [
                        { name: "æ°´æ¥Šé…¸", smiles: "Oc1ccccc1C(=O)O" },
                        { name: "ä¹™é…¸é…", smiles: "CC(=O)OC(C)=O" }
                    ],
                    mechanism: "è¦ªæ ¸é†¯åŸºå–ä»£åæ‡‰"
                }]
            },
            "c1ccccc1OC(=O)C": { // é˜¿æ–¯åŒ¹éˆèŠ³é¦™åŒ–å¯«æ³•å‚™ä»½
                 name: "é˜¿æ–¯åŒ¹éˆ (Aspirin)",
                 description: "éé¡å›ºé†‡æ¶ˆç‚è—¥ï¼Œç¶“å…¸çš„é…¯åŒ–åæ‡‰ç”¢ç‰©ã€‚",
                 steps: [{
                     type: "åˆ‡æ–· (Disconnection)",
                     target: "é…¯éµ (Ester Linkage)",
                     explanation: "åˆ‡æ–·é…šé…¯éµï¼Œé€™æ˜¯æœ€å®¹æ˜“å½¢æˆçš„éµçµã€‚",
                     reagents: [
                         { name: "æ°´æ¥Šé…¸", smiles: "Oc1ccccc1C(=O)O" },
                         { name: "ä¹™é…¸é…", smiles: "CC(=O)OC(C)=O" }
                     ],
                     mechanism: "è¦ªæ ¸é†¯åŸºå–ä»£åæ‡‰"
                 }]
            },
            "CC(=O)Nc1ccc(O)cc1": {
                name: "ä¹™é†¯èƒºé…š (Paracetamol)",
                description: "å¸¸è¦‹çš„è§£ç†±é®ç—›è—¥ (æ™®æ‹¿ç–¼)ã€‚",
                steps: [{
                    type: "åˆ‡æ–· (Disconnection)",
                    target: "é†¯èƒºéµ (Amide Linkage)",
                    explanation: "åˆ‡æ–·æ°®èˆ‡ç¾°åŸºç¢³ä¹‹é–“çš„éµçµã€‚",
                    reagents: [
                        { name: "å°èƒºåŸºè‹¯é…š", smiles: "Nc1ccc(O)cc1" },
                        { name: "ä¹™é…¸é…", smiles: "CC(=O)OC(C)=O" }
                    ],
                    mechanism: "èƒºåŸºçš„é†¯åŒ–åæ‡‰"
                }]
            },
            "CCOC(=O)c1ccc(N)cc1": {
                name: "è‹¯ä½å¡å›  (Benzocaine)",
                description: "å±€éƒ¨éº»é†‰è—¥ï¼Œç°¡å–®çš„é…¯é¡çµæ§‹ã€‚",
                steps: [{
                    type: "åˆ‡æ–· (Disconnection)",
                    target: "é…¯éµ (Ester Linkage)",
                    explanation: "åˆ‡æ–·ä¹™æ°§åŸºèˆ‡ç¾°åŸºä¹‹é–“çš„éµçµã€‚",
                    reagents: [
                        { name: "å°èƒºåŸºè‹¯ç”²é…¸ (PABA)", smiles: "Nc1ccc(C(=O)O)cc1" },
                        { name: "ä¹™é†‡", smiles: "CCO" }
                    ],
                    mechanism: "Fischer é…¯åŒ–åæ‡‰ (é…¸å‚¬åŒ–)"
                }]
            },
            "Cn1cnc2c1c(=O)n(C)c(=O)n2C": {
                name: "å’–å•¡å›  (Caffeine)",
                description: "é»ƒå˜Œå‘¤ç”Ÿç‰©é¹¼ï¼Œä¸­æ¨ç¥ç¶“èˆˆå¥®åŠ‘ã€‚",
                steps: [
                    {
                        type: "åˆ‡æ–· (Disconnection)",
                        target: "ç”²åŸºåŒ–é€†æ¨",
                        explanation: "å°‡æ°®åŸå­ä¸Šçš„ç”²åŸºåˆ‡æ–·ï¼Œå›æ¨è‡³é»ƒå˜Œå‘¤éª¨æ¶ã€‚",
                        reagents: [
                            { name: "é»ƒå˜Œå‘¤", smiles: "O=c1[nH]c(=O)c2[nH]cnc2[nH]1" },
                            { name: "ç¢˜ç”²çƒ·", smiles: "CI" }
                        ],
                        mechanism: "N-çƒ·åŸºåŒ–åæ‡‰"
                    },
                    {
                        type: "éª¨æ¶æ§‹å»º",
                        target: "å˜§å•¶ç’°åˆæˆ",
                        explanation: "Traube å˜Œå‘¤åˆæˆæ³•ã€‚",
                        reagents: [
                            { name: "äºŒç”²åŸºè„²", smiles: "CNC(=O)NC" },
                            { name: "æ°°ä¹™é…¸", smiles: "N#CCC(=O)O" }
                        ],
                        mechanism: "ç¸®åˆç’°åŒ–"
                    }
                ]
            },
            // æ–°å¢ï¼šå¸ƒæ´›èŠ¬
            "CC(C)Cc1ccc(C(C)C(=O)O)cc1": {
                name: "å¸ƒæ´›èŠ¬ (Ibuprofen)",
                description: "éé¡å›ºé†‡æ¶ˆç‚è—¥ (NSAID)ï¼Œå¸¸è¦‹çš„æ­¢ç—›è—¥ã€‚",
                steps: [
                    {
                        type: "å®˜èƒ½åŸºè½‰æ› (FGI)",
                        target: "ç¾§é…¸å½¢æˆ",
                        explanation: "ç¾§é…¸åŸºåœ˜å¯ç”±æ°°åŸºæ°´è§£è€Œä¾† (Boot Process)ã€‚",
                        reagents: [
                            { name: "å‰é«”è…ˆåŒ–ç‰©", smiles: "CC(C)Cc1ccc(C(C)C#N)cc1" }
                        ],
                        mechanism: "è…ˆçš„æ°´è§£"
                    },
                    {
                        type: "åˆ‡æ–· (Disconnection)",
                        target: "èŠ³é¦™ç’°çƒ·åŸºåŒ–",
                        explanation: "ç•°ä¸åŸºè‹¯éª¨æ¶å¯é€šé Friedel-Crafts åæ‡‰æ§‹å»ºã€‚",
                        reagents: [
                            { name: "ç•°ä¸åŸºè‹¯", smiles: "CC(C)Cc1ccccc1" },
                            { name: "ä¹™é†¯æ°¯ (å¾ŒçºŒè½‰åŒ–)", smiles: "CC(=O)Cl" }
                        ],
                        mechanism: "Friedel-Crafts é†¯åŒ–"
                    }
                ]
            },
            // æ–°å¢ï¼šç£ºèƒº
            "Nc1ccc(S(N)(=O)=O)cc1": {
                name: "ç£ºèƒº (Sulfanilamide)",
                description: "ç¬¬ä¸€ç¨®å»£æ•ˆæŠ—èŒè—¥ç‰©ï¼Œç£ºèƒºé¡è—¥ç‰©çš„æ¯é«”ã€‚",
                steps: [
                    {
                        type: "ä¿è­·åŸºç§»é™¤",
                        target: "é†¯èƒºæ°´è§£",
                        explanation: "èƒºåŸºåœ¨åˆæˆéç¨‹ä¸­éœ€ä¿è­· (å¦‚ä¹™é†¯åŒ–) ä»¥é¿å…å‰¯åæ‡‰ã€‚",
                        reagents: [
                            { name: "ä¹™é†¯ç£ºèƒº", smiles: "CC(=O)Nc1ccc(S(N)(=O)=O)cc1" }
                        ],
                        mechanism: "é†¯èƒºæ°´è§£"
                    },
                    {
                        type: "åˆ‡æ–· (Disconnection)",
                        target: "ç£ºé†¯èƒºéµ",
                        explanation: "ç£ºé†¯æ°¯èˆ‡æ°¨åæ‡‰ç”Ÿæˆç£ºé†¯èƒºã€‚",
                        reagents: [
                            { name: "å°ä¹™é†¯èƒºåŸºè‹¯ç£ºé†¯æ°¯", smiles: "CC(=O)Nc1ccc(S(=O)(=O)Cl)cc1" },
                            { name: "æ°¨", smiles: "N" }
                        ],
                        mechanism: "è¦ªæ ¸å–ä»£"
                    }
                ]
            },
            // æ–°å¢ï¼šæ°´æ¥Šé…¸ç”²é…¯
            "COC(=O)c1ccccc1O": {
                name: "æ°´æ¥Šé…¸ç”²é…¯ (Methyl Salicylate)",
                description: "å†¬é’æ²¹ï¼Œå…·æœ‰è–„è·å‘³ï¼Œå¸¸ç”¨æ–¼ç— ç—›è²¼å¸ƒã€‚",
                steps: [{
                    type: "åˆ‡æ–· (Disconnection)",
                    target: "é…¯éµ",
                    explanation: "å…¸å‹çš„é…¯åŒ–åæ‡‰ã€‚",
                    reagents: [
                        { name: "æ°´æ¥Šé…¸", smiles: "Oc1ccccc1C(=O)O" },
                        { name: "ç”²é†‡", smiles: "CO" }
                    ],
                    mechanism: "Fischer é…¯åŒ–åæ‡‰"
                }]
            },
            // æ–°å¢ï¼šä¹™é…¸ç•°æˆŠé…¯
            "CC(C)CCOC(C)=O": {
                name: "ä¹™é…¸ç•°æˆŠé…¯ (Isoamyl Acetate)",
                description: "é¦™è•‰æ²¹ï¼Œå…·æœ‰å¼·çƒˆçš„é¦™è•‰æ°£å‘³ã€‚",
                steps: [{
                    type: "åˆ‡æ–· (Disconnection)",
                    target: "é…¯éµ",
                    explanation: "ç”±ä¹™é…¸èˆ‡ç•°æˆŠé†‡ç¸®åˆè€Œæˆã€‚",
                    reagents: [
                        { name: "ç•°æˆŠé†‡", smiles: "CC(C)CCO" },
                        { name: "ä¹™é…¸", smiles: "CC(=O)O" }
                    ],
                    mechanism: "Fischer é…¯åŒ–åæ‡‰"
                }]
            },
            // æ–°å¢ï¼šç”²åŸºæ©™
            "CN(C)c1ccc(N=Nc2ccc(S(=O)(=O)O)cc2)cc1": {
                name: "ç”²åŸºæ©™ (Methyl Orange)",
                description: "å¸¸è¦‹çš„é…¸é¹¼æŒ‡ç¤ºåŠ‘ï¼Œé…¸æ€§é¡¯ç´…ï¼Œé¹¼æ€§é¡¯é»ƒã€‚",
                steps: [{
                    type: "åˆ‡æ–· (Disconnection)",
                    target: "å¶æ°®éµ (N=N)",
                    explanation: "å¶æ°®æŸ“æ–™é€šå¸¸ç”±é‡æ°®é¹½èˆ‡æ´»åŒ–èŠ³é¦™ç’°å¶åˆè€Œæˆã€‚",
                    reagents: [
                        { name: "é‡æ°®å°è‹¯ç£ºé…¸é¹½", smiles: "O=S(=O)([O-])c1ccc([N+]#N)cc1" },
                        { name: "N,N-äºŒç”²åŸºè‹¯èƒº", smiles: "CN(C)c1ccccc1" }
                    ],
                    mechanism: "é‡æ°®å¶åˆåæ‡‰ (Diazo Coupling)"
                }]
            },
            // æ–°å¢ï¼šé…šé…
            "Oc1ccc(cc1)C2(OC(=O)c3ccccc23)c4ccc(O)cc4": {
                name: "é…šé… (Phenolphthalein)",
                description: "é…¸é¹¼æŒ‡ç¤ºåŠ‘ï¼Œé‡é¹¼è®Šç´…ã€‚",
                steps: [{
                    type: "åˆ‡æ–· (Disconnection)",
                    target: "C-C ç¸®åˆ",
                    explanation: "é…¸é…èˆ‡å¯Œé›»å­èŠ³é¦™ç’° (é…š) çš„ç¸®åˆåæ‡‰ã€‚",
                    reagents: [
                        { name: "è‹¯é…š (2ç•¶é‡)", smiles: "Oc1ccccc1" },
                        { name: "é„°è‹¯äºŒç”²é…¸é…", smiles: "O=C1OC(=O)c2ccccc12" }
                    ],
                    mechanism: "Friedel-Crafts ç¸®åˆ"
                }]
            },
            // æ–°å¢ï¼šé›è—
            "O=C1C(=C2NC(=O)c3ccccc23)Nc4ccccc14": {
                name: "é›è— (Indigo)",
                description: "è‘—åçš„è—è‰²æŸ“æ–™ï¼Œç”¨æ–¼ç‰›ä»”è¤²æŸ“è‰²ã€‚",
                steps: [{
                    type: "åˆ‡æ–· (Disconnection)",
                    target: "é›™éµæ§‹å»º",
                    explanation: "Baeyer-Drewson é›è—åˆæˆæ³•ã€‚",
                    reagents: [
                        { name: "é„°ç¡åŸºè‹¯ç”²é†›", smiles: "O=[N+]([O-])c1ccccc1C=O" },
                        { name: "ä¸™é…®", smiles: "CC(=O)C" }
                    ],
                    mechanism: "Aldol ç¸®åˆåæ‡‰"
                }]
            }
        };

        // === åˆå§‹åŒ– RDKit ===
        window.initRDKitModule().then(function(instance) {
            RDKitModule = instance;
            const loadingMsg = document.getElementById('rdkit-loading');
            loadingMsg.classList.remove('text-orange-500', 'italic');
            loadingMsg.classList.add('text-green-600', 'font-bold');
            loadingMsg.innerHTML = "âœ“ RDKit å¼•æ“å·²å°±ç·’";
            
            const btn = document.getElementById('btn-fingerprint');
            btn.disabled = false;
            document.getElementById('input-fingerprint').removeAttribute('readonly');
            
            console.log("RDKit Version: " + RDKitModule.version());
        }).catch(err => {
            document.getElementById('rdkit-loading').innerText = "âŒ RDKit è¼‰å…¥å¤±æ•—";
            console.error(err);
        });
        
        // SmilesDrawer è¨­å®šå·²ç§»é™¤ï¼Œæ”¹ç”¨ RDKit

        // === Step 1: ç¿»è­¯ ===
        async function doTranslate() {
            const input = document.getElementById('input-trans').value.trim();
            const loader = document.getElementById('loader-trans');
            const resultBox = document.getElementById('result-trans');
            const outputText = document.getElementById('out-trans-text');
            const errorBox = document.getElementById('error-trans');

            if (!input) return;

            loader.classList.remove('hidden');
            resultBox.classList.add('hidden');
            errorBox.classList.add('hidden');

            try {
                const wikiUrl = `https://zh.wikipedia.org/w/api.php?action=query&prop=langlinks&titles=${encodeURIComponent(input)}&lllang=en&format=json&origin=*&redirects=1`;
                const response = await fetch(wikiUrl);
                const data = await response.json();
                
                let englishName = null;
                
                if (data.query && data.query.pages) {
                    const pages = data.query.pages;
                    const pageId = Object.keys(pages)[0];
                    if (pageId !== "-1" && pages[pageId].langlinks) {
                        englishName = pages[pageId].langlinks[0]["*"];
                    }
                }

                if (englishName) {
                    outputText.textContent = englishName;
                    resultBox.classList.remove('hidden');
                    document.getElementById('input-formula').value = englishName;
                    resetStep2();
                    resetStep3();
                    resetStep4();
                    resetStep5();
                    resetStep6();
                } else {
                    throw new Error("æ‰¾ä¸åˆ°å°æ‡‰çš„è‹±æ–‡ç¿»è­¯ï¼Œè«‹å˜—è©¦ç›´æ¥è¼¸å…¥è‹±æ–‡ã€‚");
                }

            } catch (e) {
                errorBox.textContent = e.message || "ç¿»è­¯å¤±æ•—";
                errorBox.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }


        // === Step 2: æŸ¥è©¢åŒ–å­¸å¼ ===
        async function doGetFormula() {
            const input = document.getElementById('input-formula').value.trim();
            const loader = document.getElementById('loader-formula');
            const resultBox = document.getElementById('result-formula');
            const errorBox = document.getElementById('error-formula');
            
            if (!input) return;

            loader.classList.remove('hidden');
            resultBox.classList.add('hidden');
            errorBox.classList.add('hidden');
            currentCID = null;

            try {
                // å…ˆæŸ¥ CID
                const cidUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(input)}/cids/JSON`;
                const cidRes = await fetch(cidUrl);
                if(!cidRes.ok) throw new Error("æ‰¾ä¸åˆ°æ­¤åŒ–åˆç‰© (PubChem)");
                const cidData = await cidRes.json();
                
                if (cidData.IdentifierList && cidData.IdentifierList.CID) {
                    currentCID = cidData.IdentifierList.CID[0];
                } else {
                    throw new Error("æ‰¾ä¸åˆ° CID");
                }

                // æŸ¥å±¬æ€§
                const propUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${currentCID}/property/MolecularFormula,IUPACName/JSON`;
                const propRes = await fetch(propUrl);
                const propData = await propRes.json();
                const props = propData.PropertyTable.Properties[0];

                document.getElementById('out-formula-text').textContent = props.MolecularFormula || "N/A";
                document.getElementById('out-cid-text').textContent = currentCID;
                document.getElementById('out-iupac-text').textContent = props.IUPACName || "N/A";
                
                resultBox.classList.remove('hidden');
                document.getElementById('input-smiles').value = input;
                resetStep3();
                resetStep4();
                resetStep5();
                resetStep6();
                
                // è‡ªå‹•å¡«å…¥ Step 5
                document.getElementById('input-3d').value = "CID: " + currentCID;

            } catch (e) {
                errorBox.textContent = "æ‰¾ä¸åˆ°è©²åŒ–åˆç‰©çš„è³‡æ–™ï¼Œè«‹æª¢æŸ¥æ‹¼å­—ã€‚";
                errorBox.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }


        // === Step 3: SMILES & çµæ§‹ (ä½¿ç”¨ RDKit) ===
        async function doGetSmiles() {
            const input = document.getElementById('input-smiles').value.trim();
            const loader = document.getElementById('loader-smiles');
            const resultBox = document.getElementById('result-smiles');
            const errorBox = document.getElementById('error-smiles');
            const container = document.getElementById('structure-container');

            if (!input) return;

            loader.classList.remove('hidden');
            resultBox.classList.add('hidden');
            errorBox.classList.add('hidden');
            container.innerHTML = ""; // Clear SVG

            try {
                let activeCID = currentCID;
                const step2Input = document.getElementById('input-formula').value.trim();

                // å¦‚æœ CID ä¸å­˜åœ¨æˆ–ä½¿ç”¨è€…ä¿®æ”¹äº†è¼¸å…¥æ¡†ï¼Œå˜—è©¦é‡æ–°ç²å– CID
                if (!activeCID || input !== step2Input) {
                    try {
                        const cidUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(input)}/cids/JSON`;
                        const cidRes = await fetch(cidUrl);
                        if (cidRes.ok) {
                            const cidData = await cidRes.json();
                            if (cidData.IdentifierList && cidData.IdentifierList.CID) {
                                activeCID = cidData.IdentifierList.CID[0];
                                currentCID = activeCID; // Update global
                                document.getElementById('input-3d').value = "CID: " + currentCID;
                            }
                        }
                    } catch (err) { console.warn("Fallback CID lookup failed"); }
                }

                if (!activeCID) {
                    throw new Error("æ‰¾ä¸åˆ°åŒ–åˆç‰© IDï¼Œè«‹ç¢ºèªåç¨±æ˜¯å¦æ­£ç¢ºã€‚");
                }

                // ç²å– SMILES
                const smilesUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${activeCID}/property/CanonicalSMILES/TXT`;
                const response = await fetch(smilesUrl, { cache: 'no-store' });
                
                if (!response.ok) throw new Error(`API éŒ¯èª¤ (Status: ${response.status})`);
                
                const smilesText = await response.text();
                let smiles = smilesText.trim(); 

                if (!smiles || smiles.length === 0) {
                     throw new Error(`è³‡æ–™åº«å›å‚³ç©ºå­—ä¸² (CID: ${activeCID})`);
                }

                // === ä½¿ç”¨ RDKit ç¹ªåœ– ===
                if (typeof RDKitModule === 'undefined' || !RDKitModule) {
                    throw new Error("RDKit å¼•æ“å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦");
                }

                const mol = RDKitModule.get_mol(smiles);
                if (!mol || mol.is_valid() === false) {
                    if(mol) mol.delete();
                    throw new Error("RDKit ç„¡æ³•è§£ææ­¤ SMILES");
                }

                // ç”Ÿæˆ SVG (800x600 è§£æåº¦)
                const svg = mol.get_svg(800, 600);
                container.innerHTML = svg;
                
                // ç²å–æ¨™æº–åŒ–å¾Œçš„ SMILES ç”¨æ–¼å¾ŒçºŒæ­¥é©Ÿ
                const canonicalSmiles = mol.get_smiles();
                mol.delete();

                // é¡¯ç¤ºçµæœ
                document.getElementById('out-smiles-code').textContent = smiles;
                resultBox.classList.remove('hidden');

                // è‡ªå‹•å¡«å…¥ Step 4 & 6
                resetStep4();
                document.getElementById('input-fingerprint').value = canonicalSmiles;
                
                resetStep5();
                
                resetStep6();
                document.getElementById('input-retro').value = canonicalSmiles;

            } catch (e) {
                errorBox.textContent = `è½‰æ›å¤±æ•—ï¼š${e.message}`;
                errorBox.classList.remove('hidden');
                console.error(e);
            } finally {
                loader.classList.add('hidden');
            }
        }

        // === Step 4: ç”Ÿæˆåˆ†å­æŒ‡ç´‹ (RDKit) ===
        function doGetFingerprint() {
            const input = document.getElementById('input-fingerprint');
            const resultBox = document.getElementById('result-fingerprint');
            const errorBox = document.getElementById('error-fingerprint');
            const fpMatrix = document.getElementById('fingerprint-matrix');
            const activeCountSpan = document.getElementById('active-bits-count');

            const smiles = input.value.trim();
            if (!smiles) return;
            if (!RDKitModule) {
                errorBox.textContent = "RDKit å¼•æ“å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å€™...";
                errorBox.classList.remove('hidden');
                return;
            }

            // Reset
            resultBox.classList.add('hidden');
            errorBox.classList.add('hidden');
            fpMatrix.innerHTML = "";

            try {
                const mol = RDKitModule.get_mol(smiles);
                if (!mol || mol.is_valid() === false) {
                    if(mol) mol.delete();
                    throw new Error("ç„¡æ•ˆçš„ SMILES åºåˆ—ï¼ŒRDKit ç„¡æ³•è§£æ");
                }

                const fp_params = JSON.stringify({ radius: 2, nBits: 2048 });
                const fp_hex = mol.get_morgan_fp(fp_params);
                mol.delete();

                let fp_bits = "";
                for (let i = 0; i < fp_hex.length; i++) {
                    fp_bits += parseInt(fp_hex[i], 16).toString(2).padStart(4, '0');
                }

                let activeCount = 0;
                const fragment = document.createDocumentFragment();

                for (let i = 0; i < fp_bits.length; i++) {
                    const bit = fp_bits[i];
                    const div = document.createElement('div');
                    div.className = `bit-box ${bit === '1' ? 'bit-1' : 'bit-0'}`;
                    div.title = `Bit ${i}: ${bit}`;
                    fragment.appendChild(div);
                    if (bit === '1') activeCount++;
                }

                fpMatrix.appendChild(fragment);
                activeCountSpan.textContent = activeCount;
                resultBox.classList.remove('hidden');

            } catch (e) {
                errorBox.textContent = "ç”ŸæˆæŒ‡ç´‹å¤±æ•—: " + e.message;
                errorBox.classList.remove('hidden');
                console.error(e);
            }
        }

        // === Step 5: ç”Ÿæˆ 3D çµæ§‹ (3Dmol.js) ===
        async function doGet3D() {
            const loader = document.getElementById('loader-3d');
            const resultBox = document.getElementById('result-3d');
            const errorBox = document.getElementById('error-3d');
            
            if (!currentCID) {
                errorBox.textContent = "å°šæœªå–å¾—åŒ–åˆç‰© CIDï¼Œè«‹å…ˆåŸ·è¡Œæ­¥é©Ÿ 2";
                errorBox.classList.remove('hidden');
                return;
            }

            loader.classList.remove('hidden');
            resultBox.classList.add('hidden');
            errorBox.classList.add('hidden');

            try {
                const sdfUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${currentCID}/SDF?record_type=3d`;
                const response = await fetch(sdfUrl);
                if (!response.ok) {
                    if (response.status === 404) throw new Error("è³‡æ–™åº«ä¸­ç„¡æ­¤åŒ–åˆç‰©çš„ 3D æ¨¡å‹");
                    throw new Error("ä¸‹è¼‰ 3D æ¨¡å‹å¤±æ•—");
                }
                
                const sdfData = await response.text();
                resultBox.classList.remove('hidden');

                setTimeout(() => {
                    const element = document.getElementById('container-3d');
                    if (!viewer3D) {
                        const config = { backgroundColor: 'white' };
                        viewer3D = $3Dmol.createViewer(element, config);
                    }
                    viewer3D.clear();
                    viewer3D.addModel(sdfData, "sdf");
                    viewer3D.setStyle({}, { stick: {radius: 0.15}, sphere: {scale: 0.3} });
                    viewer3D.zoomTo();
                    viewer3D.render();
                }, 100);

            } catch (e) {
                errorBox.textContent = e.message;
                errorBox.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }

        // === Step 6: é€†åˆæˆåˆ†æ (Vanilla JS Implementation) ===
        function analyzeFunctionalGroups(smiles) {
            const suggestions = [];
            
            if (smiles.includes("C(=O)O") || smiles.includes("OC(=O)")) {
                suggestions.push({
                    group: "é…¯åŸº (Ester)",
                    advice: "å»ºè­°åˆ‡æ–· C-O å–®éµã€‚é€™é€šå¸¸ä¾†è‡ªç¾§é…¸èˆ‡é†‡çš„åæ‡‰ã€‚",
                    retro: "R-COOH + R'-OH"
                });
            }
            if (smiles.includes("C(=O)N") || smiles.includes("NC(=O)")) {
                suggestions.push({
                    group: "é†¯èƒºåŸº (Amide)",
                    advice: "å»ºè­°åˆ‡æ–· C-N éµã€‚é€™é€šå¸¸ä¾†è‡ªç¾§é…¸è¡ç”Ÿç‰©èˆ‡èƒºçš„åæ‡‰ã€‚",
                    retro: "R-COOH + R'-NH2"
                });
            }
            if (smiles.includes("C#N")) {
                suggestions.push({
                    group: "è…ˆåŸº (Nitrile)",
                    advice: "è…ˆåŸºå¯ä»¥ç”±é¹µä»£çƒ·èˆ‡æ°°åŒ–éˆ‰åæ‡‰è£½å¾—ï¼Œæˆ–ç”±é†¯èƒºè„«æ°´è€Œä¾†ã€‚",
                    retro: "R-X + NaCN"
                });
            }
            
            if (suggestions.length === 0) {
                suggestions.push({
                    group: "è¤‡é›œ/æœªçŸ¥çµæ§‹",
                    advice: "æœªæª¢æ¸¬åˆ°ç°¡å–®çš„åˆ‡æ–·é» (é…¯/é†¯èƒº)ã€‚å»ºè­°å°‹æ‰¾ C-C éµçš„æ§‹å»ºåæ‡‰ (å¦‚ Grignard, Suzuki, Aldol)ã€‚",
                    retro: "éœ€ä½¿ç”¨å°ˆæ¥­è»Ÿé«”åˆ†æ"
                });
            }
            return suggestions;
        }

        async function doRetrosynthesis() {
            const input = document.getElementById('input-retro').value.trim();
            const loader = document.getElementById('loader-retro');
            const resultBox = document.getElementById('result-retro');
            const contentBox = document.getElementById('retro-content');
            const errorBox = document.getElementById('error-retro');

            if(!input) return;

            // Reset UI
            loader.classList.remove('hidden');
            resultBox.classList.add('hidden');
            errorBox.classList.add('hidden');
            contentBox.innerHTML = '';

            try {
                // æ¨¡æ“¬æ€è€ƒæ™‚é–“
                await new Promise(r => setTimeout(r, 600));

                let analysisData = null;
                // 1. æª¢æŸ¥æ˜¯å¦åœ¨åº«ä¸­
                if (MOLECULE_LIBRARY[input]) {
                    analysisData = { type: 'known', data: MOLECULE_LIBRARY[input] };
                } else {
                    // 2. å•Ÿç™¼å¼åˆ†æ
                    const heuristics = analyzeFunctionalGroups(input);
                    analysisData = { type: 'heuristic', data: heuristics };
                }

                // ç”¢ç”Ÿ HTML å…§å®¹
                if (analysisData.type === 'known') {
                    // === å·²çŸ¥åˆ†å­é¡¯ç¤ºé‚è¼¯ ===
                    const data = analysisData.data;
                    let html = `
                        <div class="bg-rose-50 p-6 rounded-lg border border-rose-100">
                            <h3 class="text-2xl font-bold text-rose-800 mb-2">${data.name}</h3>
                            <p class="text-gray-700">${data.description}</p>
                        </div>
                    `;

                    // éæ­·æ­¥é©Ÿ
                    data.steps.forEach((step, idx) => {
                        let reagentsHtml = '';
                        // ç”Ÿæˆè©¦åŠ‘å¡ç‰‡
                        step.reagents.forEach(r => {
                            const encodedS = encodeURIComponent(r.smiles);
                            // å°åœ– (é è¦½ç”¨)
                            const imgUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodedS}/PNG?record_type=2d&image_size=300x300`;
                            // å¤§åœ– (Modal ç”¨)
                            const largeImgUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodedS}/PNG?record_type=2d&image_size=800x800`;
                            
                            reagentsHtml += `
                                <div class="flex flex-col items-center bg-white p-2 rounded border border-gray-200 w-32 shadow-sm transition hover:shadow-md hover:border-rose-300 group cursor-pointer" onclick="openModal('${largeImgUrl}')" title="é»æ“Šæ”¾å¤§">
                                    <div class="relative w-24 h-24 flex items-center justify-center">
                                        <img src="${imgUrl}" class="max-w-full max-h-full object-contain opacity-90 group-hover:opacity-100" onerror="this.src='https://via.placeholder.com/150?text=Structure'">
                                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-white/20">
                                            <svg class="w-6 h-6 text-rose-500 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                                        </div>
                                    </div>
                                    <span class="text-xs font-bold text-gray-700 mt-1 text-center truncate w-full px-1">${r.name}</span>
                                </div>
                            `;
                        });

                        html += `
                            <div class="border-l-4 border-rose-400 pl-4 py-2 mt-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-rose-100 text-rose-700 font-bold px-2 py-1 rounded text-sm">Step ${idx + 1}</span>
                                    <span class="font-bold text-gray-800">${step.type}</span>
                                    <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs">${step.target}</span>
                                </div>
                                <p class="text-gray-600 mb-4">${step.explanation}</p>
                                
                                <div class="bg-white/50 p-4 rounded-lg border border-rose-100">
                                    <p class="text-xs text-gray-500 font-bold uppercase mb-2">å»ºè­°å‰é©…ç‰© / è©¦åŠ‘ (é»æ“Šæ”¾å¤§)</p>
                                    <div class="flex flex-wrap gap-4 items-center">
                                        ${reagentsHtml}
                                    </div>
                                    <div class="mt-3 text-sm text-rose-600 font-medium bg-rose-50 inline-block px-2 py-1 rounded">
                                        åæ‡‰é¡å‹: ${step.mechanism}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    contentBox.innerHTML = html;

                } else {
                    // === æœªçŸ¥åˆ†å­å•Ÿç™¼å¼é¡¯ç¤º (å¢å¼·ç‰ˆ) ===
                    let html = `
                        <div class="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
                            <div class="flex items-center gap-2 text-amber-800 font-bold mb-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                è‡ªå‹•åˆ†æçµæœ (Heuristic Analysis)
                            </div>
                            <p class="text-sm text-amber-700">
                                è©²åˆ†å­ä¸åœ¨æ•™å­¸è³‡æ–™åº«ä¸­ã€‚ç³»çµ±ç›®å‰ä½¿ç”¨<b>çµæ§‹ç‰¹å¾µè¦å‰‡</b>é€²è¡Œåˆæ­¥æ¨æ–·ï¼Œåƒ…ä¾›åƒè€ƒã€‚<br>
                                å°æ–¼æœªçŸ¥åˆ†å­çš„ç²¾ç¢ºé€†åˆæˆï¼Œé€šå¸¸éœ€è¦ä¾è³´æ·±åº¦å­¸ç¿’æ¨¡å‹ (Deep Learning) æˆ–é¾å¤§çš„åæ‡‰è³‡æ–™åº«ã€‚
                            </p>
                        </div>
                        
                        <h4 class="font-bold text-gray-700 mb-3">æ½›åœ¨åˆ‡æ–·é»å»ºè­°ï¼š</h4>
                        <div class="grid gap-4 md:grid-cols-2 mb-6">
                    `;

                    analysisData.data.forEach(item => {
                        html += `
                            <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm hover:border-rose-300 transition">
                                <h5 class="text-lg font-bold text-rose-600 mb-1">${item.group}</h5>
                                <p class="text-gray-600 text-sm mb-3">${item.advice}</p>
                                <div class="bg-gray-800 text-gray-200 p-2 rounded font-mono text-xs">
                                    Target â‡’ ${item.retro}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;

                    // æ–°å¢ï¼šå¤–éƒ¨å°ˆæ¥­å·¥å…·é€£çµ
                    html += `
                        <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                            <h4 class="font-bold text-blue-800 mb-2 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                å¦‚ä½•ç²å–çœŸå¯¦çš„é€†åˆæˆè·¯å¾‘ï¼Ÿ
                            </h4>
                            <p class="text-sm text-blue-700 mb-4">
                                å°æ–¼ç ”ç©¶ç´šçš„åˆ†å­ï¼ŒåŒ–å­¸å®¶é€šå¸¸ä½¿ç”¨ä»¥ä¸‹å°ˆæ¥­ AI å·¥å…·ä¾†é æ¸¬åˆæˆè·¯å¾‘ï¼š
                            </p>
                            <div class="flex flex-wrap gap-3">
                                <a href="https://rxn.res.ibm.com/" target="_blank" class="flex items-center gap-2 bg-white text-blue-700 border border-blue-200 hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm">
                                    IBM RXN (AI é æ¸¬)
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </a>
                                <a href="https://askcos.mit.edu/" target="_blank" class="flex items-center gap-2 bg-white text-blue-700 border border-blue-200 hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm">
                                    MIT ASKCOS
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </a>
                                <a href="https://scifinder.cas.org/" target="_blank" class="flex items-center gap-2 bg-white text-blue-700 border border-blue-200 hover:bg-blue-600 hover:text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm">
                                    SciFinder (æ–‡ç»)
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                </a>
                            </div>
                        </div>
                    `;
                    
                    contentBox.innerHTML = html;
                }

                resultBox.classList.remove('hidden');

            } catch (err) {
                errorBox.textContent = "åˆ†æå¤±æ•—ï¼š" + err.message;
                errorBox.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }


        // === åœ–ç‰‡ç‡ˆç®±åŠŸèƒ½ ===
        function openModal(imgUrl) {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('modal-image');
            const loader = document.getElementById('modal-loader');
            
            // é¡¯ç¤º Modal èˆ‡ Loader
            modal.classList.remove('hidden');
            loader.classList.remove('hidden');
            
            // è¨­å®šåœ–ç‰‡ä¾†æº
            img.src = imgUrl;
            
            // åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œéš±è— Loader
            img.onload = () => {
                loader.classList.add('hidden');
            };
            
            // è™•ç†è¼‰å…¥éŒ¯èª¤
            img.onerror = () => {
                loader.classList.add('hidden');
                alert("åœ–ç‰‡è¼‰å…¥å¤±æ•—");
            };
        }

        function closeModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.add('hidden');
            // æ¸…ç©ºä¾†æºä»¥ç¯€çœè³‡æº
            document.getElementById('modal-image').src = "";
        }

        // ç›£è½ Esc éµé—œé–‰ Modal
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                closeModal();
            }
        });


        // === è¼”åŠ©åŠŸèƒ½ ===
        function resetStep2() {
            document.getElementById('result-formula').classList.add('hidden');
            document.getElementById('error-formula').classList.add('hidden');
            currentCID = null;
        }
        function resetStep3() {
            document.getElementById('result-smiles').classList.add('hidden');
            document.getElementById('error-smiles').classList.add('hidden');
            const container = document.getElementById('structure-container');
            container.innerHTML = "";
        }
        function resetStep4() {
            document.getElementById('result-fingerprint').classList.add('hidden');
            document.getElementById('error-fingerprint').classList.add('hidden');
            document.getElementById('input-fingerprint').value = "";
        }
        function resetStep5() {
            document.getElementById('result-3d').classList.add('hidden');
            document.getElementById('error-3d').classList.add('hidden');
            document.getElementById('input-3d').value = currentCID ? "CID: " + currentCID : "";
            if(viewer3D) viewer3D.clear();
        }
        function resetStep6() {
            document.getElementById('result-retro').classList.add('hidden');
            document.getElementById('error-retro').classList.add('hidden');
            document.getElementById('retro-content').innerHTML = "";
            document.getElementById('input-retro').value = "";
        }

        function copySmiles() {
            const text = document.getElementById('out-smiles-code').textContent;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                alert("å·²è¤‡è£½ï¼");
            } catch (err) {
                prompt("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š", text);
            }
            document.body.removeChild(textArea);
        }

        // ä¸‹è¼‰ 2D çµæ§‹åœ–åœ–ç‰‡åŠŸèƒ½ (SVG è½‰ PNG å¼·åˆ¶ç™½åº•)
        function downloadStructureImage() {
            const container = document.getElementById('structure-container');
            const svgElement = container.querySelector('svg');
            
            if (!svgElement) {
                alert("ç›®å‰æ²’æœ‰çµæ§‹åœ–å¯ä¾›ä¸‹è¼‰ï¼");
                return;
            }
            
            // åºåˆ—åŒ– SVG
            const svgData = new XMLSerializer().serializeToString(svgElement);
            const img = new Image();
            // åŠ å…¥ charset é¿å…äº‚ç¢¼
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(svgBlob);

            img.onload = function() {
                // å»ºç«‹ Canvas ä¸¦å¡«å…¥ç™½åº•
                const canvas = document.createElement('canvas');
                // ç²å– SVG çš„åŸå§‹å°ºå¯¸ï¼Œè‹¥ç„¡å‰‡é è¨­
                const bbox = svgElement.viewBox.baseVal;
                canvas.width = bbox ? bbox.width : 800;
                canvas.height = bbox ? bbox.height : 600;
                
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                // ä¸‹è¼‰é‚è¼¯
                let name = document.getElementById('input-smiles').value.trim() || 'structure';
                name = name.replace(/[^a-zA-Z0-9_-]/g, '_');

                const link = document.createElement('a');
                link.download = `${name}_structure.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // é‡‹æ”¾è¨˜æ†¶é«”
                URL.revokeObjectURL(url);
            };
            
            img.onerror = function() {
                alert("åœ–ç‰‡è½‰æ›å¤±æ•—");
                URL.revokeObjectURL(url);
            };

            img.src = url;
        }

        // ä¸‹è¼‰ 3D çµæ§‹åœ–åŠŸèƒ½ (PNG)
        function download3DImage() {
            if (!viewer3D) {
                alert("ç›®å‰æ²’æœ‰ 3D æ¨¡å‹å¯ä¾›ä¸‹è¼‰ï¼");
                return;
            }
            
            // ç²å– Data URL
            const dataURL = viewer3D.pngURI();
            
            let name = document.getElementById('input-smiles').value.trim() || 'structure_3d';
            name = name.replace(/[^a-zA-Z0-9_-]/g, '_');

            const link = document.createElement('a');
            link.download = `${name}_3d.png`;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ä¸‹è¼‰ 3D çµæ§‹åœ–åŠŸèƒ½ (GIF å‹•ç•«) - ä¿®å¾©ç©ºç™½å•é¡Œ
        async function download3DGIF() {
            if (!viewer3D) {
                alert("ç›®å‰æ²’æœ‰ 3D æ¨¡å‹å¯ä¾›ä¸‹è¼‰ï¼");
                return;
            }

            const gifBtn = document.getElementById('btn-gif');
            const gifText = document.getElementById('gif-text');
            const loader = document.getElementById('loader-gif');
            
            // UI ç‹€æ…‹ï¼šç”Ÿæˆä¸­
            gifBtn.disabled = true;
            gifText.textContent = "ç”Ÿæˆä¸­...";
            loader.classList.remove('hidden');

            try {
                // 1. åˆå§‹åŒ– GIF
                const workerBlob = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js').then(r => r.blob());
                const workerUrl = URL.createObjectURL(workerBlob);

                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: viewer3D.getCanvas().width,
                    height: viewer3D.getCanvas().height,
                    workerScript: workerUrl
                });

                // 2. é–‹å§‹æ—‹è½‰ä¸¦æˆªåœ–
                const totalFrames = 36;
                const anglePerFrame = 10;
                
                for (let i = 0; i < totalFrames; i++) {
                    viewer3D.rotate(anglePerFrame, "y");
                    viewer3D.render();
                    
                    // é—œéµä¿®æ­£ï¼šä½¿ç”¨ pngURI() è½‰æˆ Image ç‰©ä»¶å†åŠ å…¥ GIF
                    // ç›´æ¥ addFrame(canvas) å®¹æ˜“å› ç‚º WebGL buffer clear è€Œè®Šç©ºç™½
                    const dataUrl = viewer3D.pngURI();
                    const img = new Image();
                    await new Promise((resolve) => {
                        img.onload = resolve;
                        img.src = dataUrl;
                    });
                    
                    gif.addFrame(img, {delay: 100});
                }

                // 3. æ¸²æŸ“ä¸¦ä¸‹è¼‰
                gif.on('finished', function(blob) {
                    let name = document.getElementById('input-smiles').value.trim() || 'structure_3d';
                    name = name.replace(/[^a-zA-Z0-9_-]/g, '_');
                    
                    const link = document.createElement('a');
                    link.download = `${name}_spinning.gif`;
                    link.href = URL.createObjectURL(blob);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // é‚„åŸ UI
                    gifBtn.disabled = false;
                    gifText.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> GIF å‹•ç•«`;
                    loader.classList.add('hidden');
                });

                gif.render();

            } catch (error) {
                console.error("GIF ç”Ÿæˆå¤±æ•—:", error);
                alert("GIF ç”Ÿæˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ã€‚");
                // é‚„åŸ UI
                gifBtn.disabled = false;
                gifText.textContent = "GIF å‹•ç•«";
                loader.classList.add('hidden');
            }
        }

        // ç¶å®š Enter éµ
        document.getElementById("input-trans").addEventListener("keypress", (e) => { if (e.key === "Enter") doTranslate(); });
        document.getElementById("input-formula").addEventListener("keypress", (e) => { if (e.key === "Enter") doGetFormula(); });
        document.getElementById("input-smiles").addEventListener("keypress", (e) => { if (e.key === "Enter") doGetSmiles(); });
        document.getElementById("input-fingerprint").addEventListener("keypress", (e) => { if (e.key === "Enter") doGetFingerprint(); });
        document.getElementById("input-retro").addEventListener("keypress", (e) => { if (e.key === "Enter") doRetrosynthesis(); });

    </script>
</body>
</html>
